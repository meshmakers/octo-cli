steps:
  - task: PowerShell@2
    displayName: 'Updating chocolatey package version'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "Source path $(Build.SourcesDirectory)"
        Write-Host "Artifacts path $(Build.ArtifactStagingDirectory)"
        $sourcesDir = "$(Build.SourcesDirectory)/src/publishDefinitions/chocolatey/"
        $destinationDir = '$(Build.ArtifactStagingDirectory)/packages/chocolatey/'
        Copy-Item -Path $sourcesDir -Destination $destinationDir -Recurse
        
        $file = "$destinationDir/octo-cli/octo-cli.nuspec"
        $content = Get-Content -Path $file
        $updatedContent = $content -replace '__VERSION__', '$(Build.BuildNumber)'
        Set-Content -Path $file -Value $updatedContent

        $file = "$destinationDir/octo-cli/tools/chocolateyinstall.ps1"
        $content = Get-Content -Path $file
        $updatedContent = $content -replace '__VERSION__', '$(Build.BuildNumber)'
        Set-Content -Path $file -Value $updatedContent
  - task: PublishBuildArtifacts@1
    displayName: Publish metadata for package managers
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/packages/'
      ArtifactName: 'octo-cli'
      publishLocation: 'Container'